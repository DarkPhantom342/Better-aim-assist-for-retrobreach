local v0=loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))();
local v1=game:GetService("Players");
local v2=game:GetService("RunService");
local v3=game:GetService("UserInputService");
local v4=workspace.CurrentCamera;
local v5=v1.LocalPlayer;

local v8=0.1; -- Stronk (Assist Strength)
local v9=false; -- AimAssistToggle
local v10=40; -- Aim FOV (px)
local v11="CFrame"; -- Aim Mode (Fixed to CFrame)
local v12="HumanoidRootPart"; -- Target Part
local v13=false; -- TeamCheckToggle (This is "Ignore exact team", still useful)
local v14=false; -- DeadCheckToggle
local v48=false; -- WallCheckToggle

-- These variables are back to being controlled by GUI toggles, with new names
local disableForFoundation = false;
local disableForCounterforces = false;
local disableForAnomalies = false;
local disableForGOC = false;

-- Fluent GUI setup
local v15=v0:CreateWindow({Title="Aim Assist",SubTitle="by AGTV",TabWidth=150,Size=UDim2.fromOffset(450,380),Acrylic=false,Theme="Dark",MinimizeKey=Enum.KeyCode.Insert});
local v16=v15:AddTab({Title="Main",Icon="target"});

v16:AddToggle("AimAssistToggle",{Title="Aim Assist",Default=false,Callback=function(v18) v9=v18;end});
v16:AddSlider("FollowSlider",{Title="Stronk",Default=10,Min=1,Max=50,Rounding=0,Callback=function(v20) v8=v20/100 ;end});
v16:AddSlider("FOVSlider",{Title="Aim FOV (px)",Default=40,Min=1,Max=100,Rounding=0,Callback=function(v21) v10=v21;end});
v16:AddDropdown("AimModeDropdown",{Title="Aim Mode",Values={"CFrame"},Default="CFrame",Callback=function(v22) v11=v22;end});
v16:AddDropdown("TargetPartDropdown",{Title="Target Part",Values={"Head","HumanoidRootPart"},Default="HumanoidRootPart",Callback=function(v23) v12=v23;end});
v16:AddToggle("TeamCheckToggle",{Title="Ignore Exact Team",Default=false,Callback=function(v24) v13=v24;end}); -- Renamed for clarity
v16:AddToggle("DeadCheckToggle",{Title="Dead Check",Default=false,Callback=function(v25) v14=v25;end});
v16:AddToggle("WallCheckToggle",{Title="Wall Check",Default=false,Callback=function(value) v48=value;end});

-- Reinstated manual toggles with new group names and consistent double quotes
v16:AddToggle("FoundationToggle",{Title="Disable for Foundation",Default=false,Callback=function(value) disableForFoundation = value;end});
v16:AddToggle("CounterforcesToggle",{Title="Disable for Counter-forces",Default=false,Callback=function(value) disableForCounterforces = value;end});
v16:AddToggle("AnomaliesToggle",{Title="Disable for Anomalies",Default=false,Callback=function(value) disableForAnomalies = value;end});
v16:AddToggle("GOCToggle",{Title="Disable for GOC",Default=false,Callback=function(value) disableForGOC = value;end});

-- NEW: Table to store excluded usernames
local excludedUsernames = {};
-- NEW: Variable to hold the text input for usernames
local usernameInputBox = nil;

-- NEW: Section for Username Exclusion
local exclusionSection = v16:AddSection("Username Exclusion");

-- NEW: Text input for usernames
usernameInputBox = exclusionSection:AddInput("UsernameInput", {
    Title = "Username to Exclude",
    Placeholder = "Enter username...",
    Default = "",
    Callback = function(value)
        -- You could potentially validate input here, but for now, just stores it in the textbox
    end
});

-- NEW: Button to add username to exclusion list
exclusionSection:AddButton("AddUsernameButton", {
    Title = "Add to Exclusion List",
    Callback = function()
        local username = usernameInputBox.Value;
        if username and username ~= "" then
            -- Convert to lowercase for case-insensitive comparison
            local lowerCaseUsername = string.lower(username);
            if not table.find(excludedUsernames, lowerCaseUsername) then
                table.insert(excludedUsernames, lowerCaseUsername);
                v15:Notify({Title = "Exclusion List", Content = username .. " added.", Duration = 3});
                usernameInputBox:SetValue(""); -- Clear the input box
            else
                v15:Notify({Title = "Exclusion List", Content = username .. " is already in the list.", Duration = 3});
            end
        end
    end
});

-- NEW: Button to remove username from exclusion list
exclusionSection:AddButton("RemoveUsernameButton", {
    Title = "Remove from Exclusion List",
    Callback = function()
        local username = usernameInputBox.Value;
        if username and username ~= "" then
            local lowerCaseUsername = string.lower(username);
            local foundIndex = nil;
            for i, v in ipairs(excludedUsernames) do
                if v == lowerCaseUsername then
                    foundIndex = i;
                    break;
                end
            end
            if foundIndex then
                table.remove(excludedUsernames, foundIndex);
                v15:Notify({Title = "Exclusion List", Content = username .. " removed.", Duration = 3});
                usernameInputBox:SetValue(""); -- Clear the input box
            else
                v15:Notify({Title = "Exclusion List", Content = username .. " not found in the list.", Duration = 3});
            end
        end
    end
});

-- Player count display setup: Templates for labels
-- Renamed label templates for consistency
local foundationLabelTemplate = Instance.new("TextLabel")
foundationLabelTemplate.Text = "0"
foundationLabelTemplate.TextColor3 = Color3.fromRGB(0, 0, 139)
foundationLabelTemplate.TextSize = 16
foundationLabelTemplate.BackgroundTransparency = 1
foundationLabelTemplate.Size = UDim2.new(0, 50, 0, 20)
foundationLabelTemplate.Font = Enum.Font.SourceSansBold

local counterforcesLabelTemplate = Instance.new("TextLabel")
counterforcesLabelTemplate.Text = "0"
counterforcesLabelTemplate.TextColor3 = Color3.fromRGB(0, 100, 0)
counterforcesLabelTemplate.TextSize = 16
counterforcesLabelTemplate.BackgroundTransparency = 1
counterforcesLabelTemplate.Size = UDim2.new(0, 50, 0, 20)
counterforcesLabelTemplate.Font = Enum.Font.SourceSansBold

local anomaliesLabelTemplate = Instance.new("TextLabel")
anomaliesLabelTemplate.Text = "0"
anomaliesLabelTemplate.TextColor3 = Color3.fromRGB(255, 0, 0)
anomaliesLabelTemplate.TextSize = 16
anomaliesLabelTemplate.BackgroundTransparency = 1
anomaliesLabelTemplate.Size = UDim2.new(0, 50, 0, 20)
anomaliesLabelTemplate.Font = Enum.Font.SourceSansBold

local gocLabelTemplate = Instance.new("TextLabel")
gocLabelTemplate.Text = "0"
gocLabelTemplate.TextColor3 = Color3.fromRGB(128, 128, 128)
gocLabelTemplate.TextSize = 16
gocLabelTemplate.BackgroundTransparency = 1
gocLabelTemplate.Size = UDim2.new(0, 50, 0, 20)
gocLabelTemplate.Font = Enum.Font.SourceSansBold


local function setupPlayerCounterGui()
    local existingScreenGui = v5.PlayerGui:FindFirstChild("PlayerCounterDisplay")
    if existingScreenGui then existingScreenGui:Destroy() end

    local newScreenGui = Instance.new("ScreenGui")
    newScreenGui.Name = "PlayerCounterDisplay"
    newScreenGui.Parent = v5.PlayerGui

    local yOffset = 0.4
    local lineHeight = 0.05

    -- Update label creation with new names
    local currentFoundationLabel = foundationLabelTemplate:Clone()
    currentFoundationLabel.Name = "FoundationCount"
    currentFoundationLabel.Position = UDim2.new(0, 10, yOffset, 0)
    currentFoundationLabel.Parent = newScreenGui
    yOffset = yOffset + lineHeight

    local currentCounterforcesLabel = counterforcesLabelTemplate:Clone()
    currentCounterforcesLabel.Name = "CounterforcesCount"
    currentCounterforcesLabel.Position = UDim2.new(0, 10, yOffset, 0)
    currentCounterforcesLabel.Parent = newScreenGui
    yOffset = yOffset + lineHeight

    local currentAnomaliesLabel = anomaliesLabelTemplate:Clone()
    currentAnomaliesLabel.Name = "AnomaliesCount"
    currentAnomaliesLabel.Position = UDim2.new(0, 10, yOffset, 0)
    currentAnomaliesLabel.Parent = newScreenGui
    yOffset = yOffset + lineHeight

    local currentGocLabel = gocLabelTemplate:Clone()
    currentGocLabel.Name = "GOCCount"
    currentGocLabel.Position = UDim2.new(0, 10, yOffset, 0)
    currentGocLabel.Parent = newScreenGui
end

v5.CharacterAdded:Connect(function(character)
    setupPlayerCounterGui()
end)

setupPlayerCounterGui()


local function hasLineOfSight(camera, targetPart)
    local origin = camera.CFrame.Position
    local targetPosition = targetPart.Position
    local direction = (targetPosition - origin).Unit
    local distance = (targetPosition - origin).Magnitude

    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    if v5.Character then
        raycastParams.FilterDescendantsInstances = {v5.Character}
    else
        raycastParams.FilterDescendantsInstances = {}
    end

    local raycastResult = workspace:Raycast(origin, direction * (distance + 1), raycastParams)

    if raycastResult then
        local hitInstance = raycastResult.Instance
        if hitInstance == targetPart or (targetPart.Parent and hitInstance:IsDescendantOf(targetPart.Parent)) then
            return true
        else
            return false
        end
    end
    return true
end

local function playerHasItems(player)
    if not player then return false end
    local backpack = player:FindFirstChildOfClass("Backpack")
    if backpack and #backpack:GetChildren() > 0 then return true end
    if player.Character then
        for _, child in ipairs(player.Character:GetChildren()) do
            if child:IsA("Tool") then return true end
        end
    end
    return false
end

-- Helper function to determine which group a team name belongs to
local function getTeamGroup(teamName)
    -- Define team groups with new names
    local foundationTeamNames = {"Mobile Task Forces", "Foundation Personnel", "Security Department"};
    local counterforcesTeamNames = {"Class-D", "Chaos Insurgency"};
    local anomaliesTeamNames = {"Serpent's Hand", "SCP"};
    local gocTeamNames = {"Global Occult Coalition"};

    if teamName then
        if table.find(foundationTeamNames, teamName) then
            return "Foundation"
        elseif table.find(counterforcesTeamNames, teamName) then
            return "Counter-forces"
        elseif table.find(anomaliesTeamNames, teamName) then
            return "Anomalies"
        elseif table.find(gocTeamNames, teamName) then
            return "GOC"
        end
    end
    return nil -- No group found
end

                local function findBestTarget()
    local bestTargetPart = nil;
    local minFovDistance = v10;
    local screenCenter = Vector2.new(v4.ViewportSize.X / 2, v4.ViewportSize.Y / 2);

    local foundationTeamNames = {"Mobile Task Forces", "Foundation Personnel", "Security Department"};
    local counterforcesTeamNames = {"Class-D", "Chaos Insurgency"};
    local anomaliesTeamNames = {"Serpent's Hand", "SCP"};
    local gocTeamNames = {"Global Occult Coalition"};

    local currentFoundationCount = 0
    local currentCounterforcesCount = 0
    local currentAnomaliesCount = 0
    local currentGOCCount = 0

    local localPlayerTeamName = v5.Team and v5.Team.Name or "";
    local localPlayerTeamGroup = getTeamGroup(localPlayerTeamName);

    -- Debug: Check if local player team is identified
    print("Local Player Team Name:", localPlayerTeamName);
    print("Local Player Team Group:", localPlayerTeamGroup);

    for _, targetPlayer in ipairs(v1:GetPlayers()) do
        -- Debug: Player processing start
        print("Processing player:", targetPlayer.Name);

        if (targetPlayer ~= v5) and targetPlayer.Character and targetPlayer.Character:FindFirstChild(v12) then
            local targetTeamName = targetPlayer.Team and targetPlayer.Team.Name or "";
            local targetTeamGroup = getTeamGroup(targetTeamName);
            local targetPlayerName = string.lower(targetPlayer.Name);

            -- Debug: Target player team and name info
            print("  Target Name:", targetPlayer.Name, "Team:", targetTeamName, "Group:", targetTeamGroup);

            -- NEW: Check if the target player's username is in the excludedUsernames list
            if table.find(excludedUsernames, targetPlayerName) then
                print("  SKIPPED:", targetPlayer.Name, "- Excluded by username.");
                continue;
            end

            local targetHumanoid = targetPlayer.Character:FindFirstChildOfClass("Humanoid");
            local isAlive = targetHumanoid and (targetHumanoid.Health > 0);

            if isAlive then
                if targetTeamGroup == "Foundation" then
                    currentFoundationCount = currentFoundationCount + 1
                elseif targetTeamGroup == "Counter-forces" then
                    currentCounterforcesCount = currentCounterforcesCount + 1
                elseif targetTeamGroup == "Anomalies" then
                    currentAnomaliesCount = currentAnomaliesCount + 1
                elseif targetTeamGroup == "GOC" then
                    currentGOCCount = currentGOCCount + 1
                end
            end

            -- Layer 1: Auto-disable within my own group.
            if localPlayerTeamGroup and targetTeamGroup and (localPlayerTeamGroup == targetTeamGroup) then
                print("  SKIPPED:", targetPlayer.Name, "- Same group as local player.");
                continue;
            end

            -- Layer 2: Manual "Ignore Exact Team" toggle (v13)
            if v13 and (targetTeamName == localPlayerTeamName) then
                print("  SKIPPED:", targetPlayer.Name, "- Same exact team (Ignore Exact Team toggle ON).");
                continue;
            end

            -- Layer 3: Manual "Disable for Group" toggles.
            if (disableForFoundation and targetTeamGroup == "Foundation") then
                print("  SKIPPED:", targetPlayer.Name, "- Disabled for Foundation group.");
                continue;
            end
            if (disableForCounterforces and targetTeamGroup == "Counter-forces") then
                print("  SKIPPED:", targetPlayer.Name, "- Disabled for Counter-forces group.");
                continue;
            end
            if (disableForAnomalies and targetTeamGroup == "Anomalies") then
                print("  SKIPPED:", targetPlayer.Name, "- Disabled for Anomalies group.");
                continue;
            end
            if (disableForGOC and targetTeamGroup == "GOC") then
                print("  SKIPPED:", targetPlayer.Name, "- Disabled for GOC group.");
                continue;
            end

            -- Specific handling for SCP (always skip if they don't have items)
            if targetTeamName == "SCP" then
                if not playerHasItems(targetPlayer) then
                    print("  SKIPPED:", targetPlayer.Name, "- SCP without items.");
                    continue;
                end
            end

            if v14 and (not isAlive) then -- Corrected logic: if DeadCheck is ON and target is NOT alive
                print("  SKIPPED:", targetPlayer.Name, "- Dead (Dead Check toggle ON).");
                continue;
            end

            local targetPart = targetPlayer.Character[v12];
            if not targetPart then
                print("  SKIPPED:", targetPlayer.Name, "- Target part ("..v12..") not found.");
                continue;
            end

            local worldToViewportPoint, isOnScreen = v4:WorldToViewportPoint(targetPart.Position);

            if isOnScreen then
                print("  Target:", targetPlayer.Name, "- Is on screen.");
                if v48 and not hasLineOfSight(v4, targetPart) then
                    print("  SKIPPED:", targetPlayer.Name, "- No line of sight (Wall Check toggle ON).");
                    continue
                end

                local targetScreenPosition = Vector2.new(worldToViewportPoint.X, worldToViewportPoint.Y);
                local fovDistance = (targetScreenPosition - screenCenter).Magnitude;
                print("  Target:", targetPlayer.Name, "- FOV Distance:", fovDistance, "Min FOV Distance:", minFovDistance);

                if (fovDistance < minFovDistance) then
                    minFovDistance = fovDistance;
                    bestTargetPart = targetPart;
                    print("  Best Target Candidate Found:", targetPlayer.Name);
                end
            else
                print("  SKIPPED:", targetPlayer.Name, "- Not on screen.");
            end
        else
            print("  SKIPPED:", targetPlayer.Name, "- Invalid character or target part not found for v12.");
        end
    end

    local currentScreenGui = v5.PlayerGui:FindFirstChild("PlayerCounterDisplay")
    if currentScreenGui then
        local labelFoundation = currentScreenGui:FindFirstChild("FoundationCount")
        if labelFoundation then labelFoundation.Text = tostring(currentFoundationCount) end

        local labelCounterforces = currentScreenGui:FindFirstChild("CounterforcesCount")
        if labelCounterforces then labelCounterforces.Text = tostring(currentCounterforcesCount) end

        local labelAnomalies = currentScreenGui:FindFirstChild("AnomaliesCount")
        if labelAnomalies then labelAnomalies.Text = tostring(currentAnomaliesCount) end

        local labelGOC = currentScreenGui:FindFirstChild("GOCCount")
        if labelGOC then labelGOC.Text = tostring(currentGOCCount) end
    end
    
    if bestTargetPart then
        print("Final Best Target Found:", bestTargetPart.Parent.Name);
    else
        print("No Best Target Found for this frame.");
    end

    return bestTargetPart;
end

v2.RenderStepped:Connect(function()
    if v9 then
        -- Debug: Aim Assist is ON
        print("Aim Assist is ON. Looking for target...");
        local target = findBestTarget();
        if target then
            -- Debug: Target found, applying aim assist
            print("Target found by RenderStepped:", target.Parent.Name);
            local direction = (target.Position - v4.CFrame.Position).Unit;
            v4.CFrame = v4.CFrame:Lerp(CFrame.new(v4.CFrame.Position, v4.CFrame.Position + direction), v8);
        else
            -- Debug: No target found
            print("Aim Assist ON, but no target found.");
        end
    else
        -- Debug: Aim Assist is OFF
        -- print("Aim Assist is OFF."); -- Commented out to avoid spamming console when off
    end
end);
